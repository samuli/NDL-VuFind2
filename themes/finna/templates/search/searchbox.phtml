<?
    $browse = isset($browse) ? $browse : false;
    // Set default value if necessary:
    if (!isset($this->searchClassId)) {
        $this->searchClassId = 'Solr';
    }

    // Load search actions and settings (if any):
    $options = $this->searchOptions($this->searchClassId);
    $handlers = $this->searchbox()->getHandlers(
        $this->searchClassId,
        isset($this->searchIndex) ? $this->searchIndex : null
    );
    $handlerCount = count($handlers);
    $basicSearch = $browse ? "browse-{$browse}" : $options->getSearchAction();
    $searchHome = $options->getSearchHomeAction();
    $advSearch = $options->getAdvancedSearchAction();
    $lastSort = $browse ? null : $options->getLastSort();
    $lastLimit = $browse ? null : $options->getLastLimit();
    $daterange
       = $this->params && method_exists($this->params, 'getSpatialDateRangeFilter')
       ? $this->params->getSpatialDateRangeFilter()
       : null
    ;
    $metalibSet = $this->metalibSet;
    if (!isset($metalibSet)) {
      $metalibSet
         = $this->params && method_exists($this->params, 'getMetalibSearchSet')
            ? $this->params->getMetalibSearchSet()
            : null
      ;
    }

    // Set up Finna Main Tabs:
    $module = $this->layout()->templateDir;
    $action = $this->layout()->templateName;
    if (!$browse) {
      if (($module === 'search' && $action === 'results' && $this->searchType != 'advanced')
         || ($module === 'metalib' && $action === 'search' && $this->searchType != 'advanced') 
         || ($module === 'primo' && $action === 'search' && $this->searchType != 'advanced')
         || ($module == 'combined' && $action == 'results')
      ) {
         $searchTabs = $this->searchtabs($this->searchClassId, $this->lookfor, $this->searchIndex, $this->searchType, $this->layout()->savedTabs);
         $this->layout()->finnaMainTabs = $this->render('search/searchTabs', array('searchTabs' => $searchTabs));
         $this->layout()->searchTabs = $searchTabs;
      }
    }
?>
<? if ($this->searchType != 'advanced'): ?>
  <form role="search" class="searchForm navbar-form navbar-left col-xs-12 col-sm-10 col-md-8 col-lg-7  <?=$handlerCount < 2 ? 'input-field-only' :''; ?>" method="get" action="<?=$this->url($basicSearch)?>" name="searchForm" autocomplete="off">
    <label for="searchForm_lookfor" class="sr-only" hidden><?=$this->transEsc("Find")?></label><input class="searchForm_lookfor form-control search-query<? if($this->searchbox()->autocompleteEnabled($this->searchClassId)):?> autocomplete searcher:<?=$this->escapeHtmlAttr($this->searchClassId) ?><? endif ?>" placeholder="<?=$this->transEsc("Find")?>..." id="searchForm_lookfor" type="text" name="lookfor" value="<?=$this->escapeHtmlAttr($this->lookfor)?>"/>
    <span class="clear-button<?=$this->lookfor ? '' : ' hidden'?>"></span>
    <? if ($handlerCount > 1): ?>
      <span class="hidden sr-only"><?=$this->transEsc("Narrow Search")?></span>
      <div class="dropdown form-control type-dropdown">
      <?
        $label = $handlers[0]['label'];
        $value = $handlers[0]['value'];
        foreach ($handlers as $handler) {
          if ($handler['selected']) {
            $label = $handler['label'];
            $value = $handler['value'];
            break;
          }
        }
      ?>
      <input type="hidden" name="type" value="<?=$this->escapeHtmlAttr($value)?>" />
      <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span><?=$this->transEsc($label)?></span> <i class="fa fa-arrow-down"></i></a>
      <ul class="searchForm_type dropdown-menu" id="searchForm_type" data-native-menu="false">
        <? foreach ($handlers as $handler): ?>
          <li class="select-type">
            <input type="hidden" value="<?=$this->escapeHtmlAttr($handler['value'])?>" />
            <span><?=$this->transEsc($handler['label'])?></span>
          </li>
        <? endforeach; ?>
      </ul>
    </div>
    <? elseif ($handlerCount == 1): ?>
      <input type="hidden" name="type" value="<?=$this->escapeHtmlAttr($handlers[0]['value'])?>" />
    <? endif; ?>
    <button type="submit" class="btn btn-primary"><i class="fa fa-search"></i> <span class="sr-only"><?=$this->transEsc("Find")?></span></button>

    <? $shards = $options->getShards(); if ($options->showShardCheckboxes() && !empty($shards)): ?>
      <?
      $selectedShards = isset($this->selectedShards)
          ? $this->selectedShards : $options->getDefaultSelectedShards();
      ?>
      <br />
      <? foreach ($shards as $shard => $val): ?>
        <? $isSelected = empty($selectedShards) || in_array($shard, $selectedShards); ?>
          <input type="checkbox" <?=$isSelected ? 'checked="checked" ' : ''?>name="shard[]" value='<?=$this->escapeHtmlAttr($shard)?>' /> <?=$this->transEsc($shard)?>
      <? endforeach; ?>
    <? endif; ?>
    <?
      $filterDetails = $this->searchbox()->getFilterDetails(
          isset($this->filterList) && is_array($this->filterList) ? $this->filterList : array(),
          isset($this->checkboxFilters) && is_array($this->checkboxFilters) ? $this->checkboxFilters : array()
      );
    ?>
     <? $defaultFilterState = $this->hasDefaultsApplied || $options->getRetainFilterSetting() ? ' checked="checked"' : ''; ?>
     <? if (!$browse && (!empty($filterDetails) || !empty($this->savedSearches))): ?>
          <div class="checkbox<?=$defaultFilterState?' checked' : ''?>">
        <label>
          <input onChange="$('.applied-filter').click();$('.navbar-form .checkbox').toggleClass('checked'); var sort = $(this).closest('form').find('input[name=sort]'); sort.val($('.navbar-form .checkbox').hasClass('checked') ? sort.data('value') : '');" type="checkbox"<?=$defaultFilterState?> class="searchFormKeepFilters"/>
          <?=$this->transEsc("basic_search_keep_filters")?>
        </label>
      </div>
      <div class="hidden">
        <? foreach ($filterDetails as $current): ?>
          <input class="applied-filter" id="<?=$this->escapeHtmlAttr($current['id'])?>" type="checkbox"<?=$defaultFilterState?> name="filter[]" value="<?=$this->escapeHtmlAttr($current['value'])?>" />
          <label for="<?=$this->escapeHtmlAttr($current['id'])?>"><?=$this->escapeHtml($current['value'])?></label>
        <? endforeach; ?>
        <? if (!empty($this->savedSearches)): ?>
          <? foreach ($this->savedSearches as $searchClass => $searchId): ?>
            <input class="applied-filter" id="search-<?=$this->escapeHtmlAttr($searchClass)?>" type="checkbox"<?=$defaultFilterState?> name="search[]" value="<?=$this->escapeHtmlAttr($searchClass . ':' . $searchId)?>" />
            <label for="<?=$this->escapeHtmlAttr($searchClass)?>"><?=$this->escapeHtml($searchId)?></label>
          <? endforeach; ?>
        <? endif; ?>
        <!-- this is a hidden element that flags whether or not default filters have been applied;
             it is intentionally unlabeled, as users are not meant to manipulate it directly. -->
        <input class="applied-filter" id="dfApplied" type="checkbox" name="dfApplied" value="1"<?=$defaultFilterState?> />
      </div>
    <? endif; ?>
    <?
      /* Load hidden limit preference from Session */
      if (!empty($lastLimit)) {
        echo '<input type="hidden" name="limit" value="' . $this->escapeHtmlAttr($lastLimit) . '" />';
      }
      if (!empty($lastSort)) {
        echo '<input type="hidden" name="sort" value="' . ($defaultFilterState ? $this->escapeHtmlAttr($lastSort) : '') . '" data-value="' . $this->escapeHtmlAttr($lastSort) . '" />';
      }
      if ($daterange && isset($daterange['field']) && isset($daterange['type'])) {
        echo '<input class="hidden applied-filter" type="checkbox"' . $defaultFilterState . ' name="' . $daterange['field'] . '_type" value="' . $this->escapeHtmlAttr($daterange['type']) . '" />';
      }
      if ($metalibSet) {
        echo '<input class="hidden applied-filter" type="checkbox"' . $defaultFilterState . ' name="set" value="' . $this->escapeHtmlAttr($metalibSet) . '" />';
      }
    
    ?>
  </form>
  <? if ($advSearch): ?>
  <div class="col-md-4 col-lg-5">
    <a href="<?=$this->url($advSearch)?>" class="btn btn-link hidden-xs hidden-sm"><i class="fa fa-search-adv"></i> <?=$this->transEsc("Advanced Search")?></a>
    <? if ($module === 'search' && !$this->translationEmpty('tooltip_local_search_html')) :?><span class="tooltip-search-local pull-right hidden-xs" data-toggle="tooltip" data-placement="auto" data-html="true" data-original-title="<?=$this->transesc('tooltip_local_search_html')?>"><i class="fa fa-info-big"></i></span><? endif; ?>
    <? if ($module === 'primo' && !$this->translationEmpty('tooltip_pci_search_html')) :?><span class="tooltip-search-pci pull-right hidden-xs" data-toggle="tooltip" data-placement="auto" data-html="true" data-original-title="<?=$this->transesc('tooltip_pci_search_html')?>"><i class="fa fa-info-big"></i></span><? endif; ?>
    <? if ($module === 'metalib' && !$this->translationEmpty('tooltip_metalib_search_html')) :?><span class="tooltip-search-metalib pull-right hidden-xs" data-toggle="tooltip" data-placement="auto" data-html="true" data-original-title="<?=$this->transesc('tooltip_metalib_search_html')?>"><i class="fa fa-info-big"></i></span><? endif; ?>
  </div>
  <? endif; ?>
  <div class="row">
    <div class="col-xs-12 col-sm-10 col-md-8 col-lg-7 text-right">
      <? $mainPage = $action === 'home' && $this->searchClassId === 'Solr'; ?>

      <? if ($browse || !$mainPage): ?>
      <a href="<?=$this->url('home');?>" class="btn btn-link"><i class="fa fa-search"></i> <?=$this->transEsc("Basic Search")?></a>
      <? endif; ?>

      <? if ($this->primo()->isAvailable() && ($browse || $this->searchClassId !== 'Primo')) : ?>
      <a href="<?=$this->url('primo-home');?>" class="btn btn-link"><i class="fa fa-search"></i> <?=$this->transEsc("Primo Search")?></a>
      <? endif; ?>

      <? if ($this->metalib()->isAvailable() && ($browse || $this->searchClassId !== 'Metalib')) : ?>
      <a href="<?=$this->url('metalib-home');?>" class="btn btn-link"><i class="fa fa-search"></i> <?=$this->transEsc("MetaLib Search")?></a>
      <? endif; ?>

      <? if ($advSearch): ?>
      <a href="<?=$this->url($advSearch)?>" class="btn btn-link hidden-xs hidden-md hidden-lg"><i class="fa fa-search-adv"></i><?=$this->transEsc("Advanced Search")?></a>
      <? endif; ?>
    </div>
  </div>
  <script type="text/javascript">$(".searchForm_lookfor:visible").focus()</script>
<? endif; ?>
